<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS180 Project 1</title>
    <style>
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #24292e;
            background-color: #fff;
        }
        
        h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }
        
        h2 {
            font-size: 1.8em;
            font-weight: 600;
            margin-top: 2em;
            margin-bottom: 1em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }
        
        h3 {
            font-size: 1.4em;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        
        p {
            margin-bottom: 1em;
            text-align: justify;
        }
        
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5em auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 2em 0;
        }
        
        .image-item {
            text-align: center;
        }
        
        .image-item img {
            margin: 0 auto 10px;
        }
        
        .image-item .caption {
            font-size: 0.9em;
            color: #586069;
            font-style: italic;
        }
        
        .shift-info {
            background-color: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.85em;
        }
        
        .runtime-info {
            color: #6f42c1;
            font-weight: 500;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2em 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e1e4e8;
        }
        
        th {
            background-color: #f6f8fa;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .math-formula {
            text-align: center;
            margin: 1.5em 0;
            padding: 1em;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-family: 'Times New Roman', serif;
        }
        
        .section-divider {
            border-top: 2px solid #e1e4e8;
            margin: 3em 0 2em 0;
        }
        
        .hero-image {
            width: 100%;
            max-width: 600px;
            margin: 2em auto;
            display: block;
        }
        
        .method-comparison {
            background-color: #fff5b7;
            border-left: 4px solid #ffb300;
            padding: 1em;
            margin: 2em 0;
        }
        
        .results-section {
            margin: 3em 0;
        }
        
        .algorithm-step {
            background-color: #e8f4f8;
            border-left: 4px solid #0366d6;
            padding: 1em;
            margin: 1em 0;
        }
        
        code {
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            font-size: 85%;
            margin: 0;
            padding: 0.2em 0.4em;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        ul {
            padding-left: 2em;
        }
        
        li {
            margin-bottom: 0.5em;
        }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            align-items: center;
        }
        
        .numerator {
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 8px;
            margin-bottom: 2px;
            min-width: 100%;
        }
        
        .denominator {
            padding-top: 8px;
            margin-top: 2px;
            min-width: 100%;
        }
    </style>
</head>
<body>    
    <header></header>
    <h1><a href="./index.html">Colorizing the Prokudin-Gorskii Images</a></h1>
    
    <section>
        <h2>Introduction</h2>
        <p>This project takes the digitized Prokudin-Gorskii glass plate images and, using image processing techniques, 
            automatically produces a color image with as few visual artifacts as possible. 
            In order to do this, I extracted the three color channel images, placed them on top of each other, 
            and aligned them so they formed a single RGB color image.</p>
        <img src="aligned_new_emir.jpg" alt="Intro Image">
        <div class="shift-info">Best Shift: G(49, 23), R(107, 40)</div>
    </section>
    
    <section>
        <h2>Methodology</h2>
        <p>My program took a glass plate image as input and produced a single color image as output. 
            First, I divided the image into three equal parts as each image was essentially the three channels stacked 
            as images on top of each other. Then, I aligned the second and third parts (G and R channels) 
            to the first (B) iteratively. I aligned the images by exhaustively searching over a window of 
            possible displacements (I chose [-15, 15] pixels), scored all of the alignments using an image 
            matching metric, and then taking the displacement with the best score for the final image output.</p>
        
        <h3>Alignment Metrics</h3>
        <p>There are different metrics to score how well the images match. In this case, I used Euclidean 
            distance (L2 norm) and Normalized Cross-Correlation (NCC) on a cropped version of the images (so that 
            the chromatic abberation on the boundaries of the image wouldn't affect the results).</p>
        
        <h3>The SSD Norm</h3>
        <p>This is the simplest metric to use on the images (formula shown below). It worked well on the smaller images, 
            but performance worsened on larger image sizes. To compute the euclidean distance, you first compute the 
            per-element difference for each index i. Square each difference and then sum up those squared values to 
            obtain the Sum-of-Squared-Differences. Finally, take the square root to get the Euclidean distance.</p>
        <div class="math-formula">
            <i>d</i>(<b>u</b>, <b>v</b>) = √(∑<sub><i>i</i>=1</sub><sup><i>n</i></sup> (<i>u<sub>i</sub></i> − <i>v<sub>i</sub></i>)<sup>2</sup>)
        </div>
        <div class="results-section">
            <div class="image-grid">
                <div class="image-item">
                    <img src="euc_cathedral.jpg" alt="Result 3">
                </div>
                <div class="image-item">
                    <img src="euc_tobolsk.jpg" alt="Result 3">
                </div>
                <div class="image-item">
                    <img src="euc_siren.jpg" alt="Result 3">
                </div>
            </div>
        </div>
        
        <h3>The NCC Norm</h3>
        <p>The Normalized Cross-Correlation metric is simply a dot product between two normalized vectors. This metric 
            performed slightly better than the L2 Norm, but the effect was most noticeable on the larger images combined 
            with the pyramid speedup. To compute the normalized cross-correlation metric, you first subtract the mean 
            intensity from each image so they have zero mean. This makes the measure invariant to brightness 
            shifts and centers the data. Then, you compute the dot product of the zero-mean image vectors which measures how much 
            the patterns align. Finally, you compute the magnitude of each vector using the L2 norm and divide the dot product 
            by the product of the magnitudes to normalize. Then, the result is between -1 and 1 where 1 indicates perfect alignment. 
            This adjusts for differences in brightness and contrast compared to simply using Euclidean distance.</p>
        <div class="math-formula">
            <span class="fraction">
                <span class="numerator">∑<sub><i>i</i></sub> (<i>u<sub>i</sub></i> − <i>ū</i>)(<i>v<sub>i</sub></i> − <i>v̄</i>)</span>
                <span class="denominator">√(∑<sub><i>i</i></sub> (<i>u<sub>i</sub></i> − <i>ū</i>)<sup>2</sup>) × √(∑<sub><i>i</i></sub> (<i>v<sub>i</sub></i> − <i>v̄</i>)<sup>2</sup>)</span>
            </span>        
        </div>
        <div class="results-section">
            <div class="image-grid">
                <div class="image-item">
                    <img src="ncc_cathedral.jpg" alt="Result 3">
                </div>
                <div class="image-item">
                    <img src="ncc_tobolsk.jpg" alt="Result 3">
                </div>
                <div class="image-item">
                    <img src="ncc_siren.jpg" alt="Result 3">
                    <div class="shift-info">Improves further with pyramid speedup as shown in gallery below.</div>
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2>Pyramid Search</h2>
        <p>For larger images, exhaustive search becomes too expensive since the pixel displacement I've set ([-15,15] pixels) 
            is too large. In this case, I implemented a faster search procedure, namely an image pyramid, that represents the 
            image at multiple scales and processes from the smallest image downwards while updating my estimate.</p>
        
        <div class="algorithm-step">
            <strong>Algorithm Steps:</strong>
            <ul>
                <li>Build a pyramid by repeatedly downsampling the input images to create lower-resolution versions.</li>
                <li>Start motion estimation (full search) at the coarsest, lowest-resolution level. At each higher level, only search for 
                    displacements in a small neighborhood (e.g. [-1,1])
                    around the motion vector found in the previous level.</li>
                <li>Double the displacement coordinates when moving from a coarser level to a finer level to account for the increased resolution.</li>
                <li>Refine the motion estimate progressively until reaching the original, full-resolution image.</li>
            </ul>
        </div>
    </section>

    <section>
        <h2>Images of Choice</h2>
        <p>I found a couple of images from the Prokudin-Gorskii collection online and ran my algorithm on them. 
            They use the normalized cross-correlation metric without a coarse-to-fine pyramid speedup since they're smaller images.</p>
        
        <div class="results-section">
            <div class="image-grid">
                <div class="image-item">
                    <img src="aligned_cross.jpg" alt="Result 3">
                    <div class="shift-info">Best Shift: G(7, -1), R(14, 0)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_jewelry.jpg" alt="Result 1">
                    <div class="shift-info">Best Shift: G(8, -2), R(16, -6)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_buildings.jpg" alt="Result 2">
                    <div class="shift-info">Best Shift: G(7, 0), R(14, 1)</div>
                </div>
                <div class="image-item">
                    <img src="cross.jpg" alt="Result 3">
                </div>
                <div class="image-item">
                    <img src="jewelry.jpg" alt="Result 1">
                </div>
                <div class="image-item">
                    <img src="buildings.jpg" alt="Result 2">
                </div>
            </div>
        </div>
    </section>

    <section>
        <h2>Image Gallery</h2>
        <p>Here is the gallery of my algorithm ran on all of the example images provided (other than Emir which is shown up top) using the NCC image metric and image pyramid speedup.</p>
        
        <div class="results-section">
            <div class="image-grid">
                <div class="image-item">
                    <img src="aligned_cathedral.jpg" alt="Result 1">
                    <div class="shift-info">Best Shift: G(1, -1), R(7, -1)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_monastery.jpg" alt="Result 2">
                    <div class="shift-info">Best Shift: G(-3, 0), R(3, 1)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_tobolsk.jpg" alt="Result 3">
                    <div class="shift-info">Best Shift: G(3, 2), R(6, 3)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_italil.jpg" alt="Result 4">
                    <div class="shift-info">Best Shift: G(39, 22), R(76, 35)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_church.jpg" alt="Result 5">
                    <div class="shift-info">Best Shift: G(25, -2), R(61, -14)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_icon.jpg" alt="Result 6">
                    <div class="shift-info">Best Shift: G(40, 16), R(90, 23)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_lastochikino.jpg" alt="Result 7">
                    <div class="shift-info">Best Shift: G(-3, -3), R(76, -8)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_lugano.jpg" alt="Result 8">
                    <div class="shift-info">Best Shift: G(41, -11), R(93, -29)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_melons.jpg" alt="Result 9">
                    <div class="shift-info">Best Shift: G(83, 4), R(176, 7)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_self_portrait.jpg" alt="Result 10">
                    <div class="shift-info">Best Shift: G(-9703, -7622), R(-9623, -7625)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_siren.jpg" alt="Result 11">
                    <div class="shift-info">Best Shift: G(-9702, -7641), R(-9654, -7655)</div>
                </div>
                <div class="image-item">
                    <img src="aligned_three_generations.jpg" alt="Result 12">
                    <div class="shift-info">Best Shift: G(-9575, -11137), R(-9519, -11135)
                    </div>
                </div>
                <div class="image-item">
                    <img src="aligned_harvesters.jpg" alt="Result 13">
                    <div class="shift-info">Best Shift: G(71, -6), R(94, 3)</div>
                </div>
            </div>
        </div>
    </section>
</body>
</html>